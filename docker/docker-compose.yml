services:
  # Gradio Web Application (Fat Container)
  # Contains: Gradio UI + 6 Python MCP servers + DSPy + MLflow client
  gradio-app:
    build:
      context: ..
      dockerfile: docker/Dockerfile.gradio
    container_name: car-log-gradio
    ports:
      - "7861:7860"
    environment:
      # Python settings
      PYTHONUNBUFFERED: "1"

      # Data storage
      DATA_PATH: /data
      USE_ATOMIC_WRITES: "true"

      # OpenAI API for DSPy
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: "gpt-5-mini"

      # MLflow tracking
      MLFLOW_TRACKING_URI: http://mlflow:5050
      MLFLOW_TRACKING_MODE: ${MLFLOW_TRACKING_MODE:-full}

      # geo-routing HTTP server
      GEO_ROUTING_URL: http://geo-routing:8002

      # Gradio server
      GRADIO_HOST: "0.0.0.0"
      GRADIO_PORT: "7860"

      # trip-reconstructor settings
      GPS_WEIGHT: "0.7"
      ADDRESS_WEIGHT: "0.3"
      CONFIDENCE_THRESHOLD: "70"

      # validation settings
      DISTANCE_VARIANCE_PERCENT: "10"
      CONSUMPTION_VARIANCE_PERCENT: "15"
      DEVIATION_THRESHOLD_PERCENT: "20"
      DIESEL_MIN_L_PER_100KM: "5"
      DIESEL_MAX_L_PER_100KM: "15"
      GASOLINE_MIN_L_PER_100KM: "6"
      GASOLINE_MAX_L_PER_100KM: "20"

      # ekasa-api settings
      EKASA_API_URL: "https://ekasa.financnasprava.sk/mdu/api/v1/opd/receipt"
      MCP_TIMEOUT_SECONDS: "60"

      # Optional: Anthropic API for dashboard OCR
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}

      # OpenTelemetry settings (logging instrumentation only)
      # Note: OTEL_EXPORTER_OTLP_ENDPOINT removed - MLflow doesn't expose gRPC OTLP endpoint
      # MLflow autolog uses HTTP tracking API instead
      OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED: "true"
      OTEL_SERVICE_NAME: "car-log-gradio"
    volumes:
      - ../data:/data
      - workspace-data:/app/workspace
      - ../code_library:/app/code_library
    depends_on:
      mlflow:
        condition: service_healthy
      geo-routing:
        condition: service_started
    restart: unless-stopped
    networks:
      - car-log-net
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:7860/')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # geo-routing HTTP Server (Node.js)
  # Provides geocoding and route calculation via REST API
  geo-routing:
    build:
      context: ..
      dockerfile: docker/Dockerfile.geo-routing
    container_name: car-log-geo-routing
    ports:
      - "8002:8002"
    environment:
      PORT: "8002"
      OSRM_BASE_URL: "https://router.project-osrm.org"
      NOMINATIM_BASE_URL: "https://nominatim.openstreetmap.org"
      CACHE_TTL_HOURS: "24"
    restart: unless-stopped
    networks:
      - car-log-net
    healthcheck:
      test: ["CMD", "node", "-e", "const http = require('http'); http.get('http://localhost:8002/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # MLflow Tracking Server
  # Tracks conversations, tool calls, and DSPy invocations
  mlflow:
    image: ghcr.io/mlflow/mlflow:v3.6.0
    container_name: car-log-mlflow
    ports:
      - "5050:5050"
    volumes:
      - mlflow-data:/mlflow
    environment:
      MLFLOW_BACKEND_STORE_URI: sqlite:///mlflow/mlflow.db
      MLFLOW_ARTIFACT_ROOT: /mlflow/artifacts
    command: >
      mlflow server
      --host 0.0.0.0
      --port 5050
      --backend-store-uri sqlite:///mlflow/mlflow.db
      --default-artifact-root /mlflow/artifacts
      --allowed-hosts "mlflow:5050,mlflow,localhost,localhost:5050,car-log-mlflow"
    restart: unless-stopped
    networks:
      - car-log-net
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5050/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

networks:
  car-log-net:
    driver: bridge

volumes:
  mlflow-data:
    driver: local
  workspace-data:
    driver: local
